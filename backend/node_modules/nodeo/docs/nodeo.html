<!DOCTYPE html>

<html>
<head>
  <title>nodeo.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="MMDP.html">
                MMDP.js
              </a>
            
              
              <a class="source" href="Utils.html">
                Utils.js
              </a>
            
              
              <a class="source" href="functions.html">
                functions.js
              </a>
            
              
              <a class="source" href="nodeo.html">
                nodeo.js
              </a>
            
              
              <a class="source" href="trap.html">
                trap.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>nodeo.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Evolutionary Algorithm, simplified, for node</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>@license GPL v3
@package nodeo
@author J. J. Merelo <a href="&#109;&#97;&#105;&#x6c;&#116;&#x6f;&#x3a;&#106;&#106;&#109;&#x65;&#114;&#101;&#x6c;&#x6f;&#64;&#103;&#109;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#109;">&#106;&#106;&#109;&#x65;&#114;&#101;&#x6c;&#x6f;&#64;&#103;&#109;&#x61;&#x69;&#x6c;&#x2e;&#x63;&#111;&#109;</a></p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>To avoid uncomprehensible radix complaint at charAt</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*jshint -W065 */</span>
<span class="hljs-comment">/*jshint smarttabs:true */</span>

<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./Utils'</span>);
<span class="hljs-keyword">var</span> nodeo = exports;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Bit-flips the whole chromosome</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invert</span> <span class="hljs-params">(chromosome)</span> </span>{
    <span class="hljs-keyword">var</span> inverted = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; inverted.length; i ++ ) {
	inverted += chromosome.charAt(i).match(<span class="hljs-regexp">/1/</span>)?<span class="hljs-string">"0"</span>:<span class="hljs-string">"1"</span>;
    }
    <span class="hljs-keyword">return</span> inverted;
}
nodeo.invert=invert;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Bit-flips a single bit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mutate</span>  <span class="hljs-params">(chromosome )</span> </span>{

    <span class="hljs-keyword">var</span> mutation_point = <span class="hljs-built_in">Math</span>.floor( <span class="hljs-built_in">Math</span>.random() * chromosome.length);
    <span class="hljs-keyword">var</span> temp = chromosome;
    <span class="hljs-keyword">var</span> flip_bit = temp.charAt(mutation_point).match(<span class="hljs-regexp">/1/</span>)?<span class="hljs-string">"0"</span>:<span class="hljs-string">"1"</span>;
    chromosome = temp.substring(<span class="hljs-number">0</span>,mutation_point) +
	flip_bit + 
	temp.substring(mutation_point+<span class="hljs-number">1</span>,temp.length) ;
    <span class="hljs-keyword">return</span> chromosome;
}

nodeo.mutate = mutate;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Interchanges a substring between the two parents</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crossover</span> <span class="hljs-params">( chrom1, chrom2 )</span> </span>{
    <span class="hljs-keyword">var</span> length = chrom1.length;
    <span class="hljs-keyword">var</span> xover_point = <span class="hljs-built_in">Math</span>.floor( <span class="hljs-built_in">Math</span>.random() * length);
    <span class="hljs-keyword">var</span> range = <span class="hljs-number">1</span> + <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * (length - xover_point) );
    <span class="hljs-keyword">var</span> new_chrom1 = chrom1.substr(<span class="hljs-number">0</span>,xover_point);
    <span class="hljs-keyword">var</span> new_chrom2 = chrom2.substr(<span class="hljs-number">0</span>,xover_point);
    new_chrom1+= chrom2.substring(xover_point,xover_point+range) +
	chrom1.substring(xover_point+range,length);
    new_chrom2+= chrom1.substring(xover_point,xover_point+range) +
	chrom2.substring(xover_point+range,length);
   <span class="hljs-keyword">return</span> [new_chrom1, new_chrom2];
}

nodeo.crossover = crossover;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Mutate all chromosomes in the population</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>nodeo.mutate_population = <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-params">( pool )</span> </span>{
    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> pool ) {
	pool[i] = mutate( pool[i]);
    }
};


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Nodeo</span><span class="hljs-params">( options )</span> </span>{

    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> options ) {
	<span class="hljs-keyword">this</span>[i] = options[i];
    }
    <span class="hljs-keyword">if</span> ( ! <span class="hljs-keyword">this</span>.population_size ) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span> (<span class="hljs-string">"0 population size"</span>);
    }
    <span class="hljs-keyword">if</span> ( ! <span class="hljs-keyword">this</span>.fitness_func ) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span> (<span class="hljs-string">"No fitness func"</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">typeof</span>( <span class="hljs-keyword">this</span>.fitness_func) === <span class="hljs-string">'function'</span> ) {
	<span class="hljs-keyword">this</span>.fitness_obj = <span class="hljs-keyword">new</span> Fitness( options.fitness_func );
    } <span class="hljs-keyword">else</span> {
	<span class="hljs-keyword">this</span>.fitness_obj = <span class="hljs-keyword">this</span>.fitness_func;
    }
    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.tournament_size ) {
	<span class="hljs-keyword">this</span>.tournament_size = <span class="hljs-number">2</span>;
    }
    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.pool_size ) {
	<span class="hljs-keyword">this</span>.pool_size = <span class="hljs-keyword">this</span>.population_size - <span class="hljs-number">2</span>;
    }

    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.chromosome_size || <span class="hljs-built_in">isNaN</span>(<span class="hljs-keyword">this</span>.chromosome_size) ) {
	<span class="hljs-keyword">throw</span> <span class="hljs-string">"Chromosome size error"</span>;
    }
    <span class="hljs-keyword">this</span>.fitness_of = {};
    <span class="hljs-keyword">this</span>.population = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>   console.log( this.fitness_obj.apply );</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">do</span> {
	<span class="hljs-keyword">var</span> chromosome = utils.random( <span class="hljs-keyword">this</span>.chromosome_size );
	<span class="hljs-keyword">if</span> ( ! (chromosome <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.fitness_of) ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <pre><code><span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.fitness_obj.apply);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">this</span>.fitness_of[chromosome] = <span class="hljs-keyword">this</span>.fitness_obj.apply( chromosome );</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <pre><code><span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">this</span>.fitness_of[chromosome]);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">this</span>.population.push( chromosome );
	}
    } <span class="hljs-keyword">while</span>( <span class="hljs-keyword">this</span>.population.length &lt; <span class="hljs-keyword">this</span>.population_size );</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.tournament_selection = tournament_selection;
    <span class="hljs-keyword">this</span>.reproduction = reproduction;
    <span class="hljs-keyword">this</span>.evaluation = evaluation;
    <span class="hljs-keyword">this</span>.generation= generation;
    <span class="hljs-keyword">this</span>.order=order;
    <span class="hljs-keyword">this</span>.incorporate=incorporate;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>create fitness function object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Fitness</span> <span class="hljs-params">( f )</span> </span>{
    <span class="hljs-keyword">this</span>.apply = f;
    
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Selects a new population of size pool_size via comparing tournament_size chromosomes and taking the best</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tournament_selection</span><span class="hljs-params">( tournament_size, pool_size )</span> </span>{
    <span class="hljs-keyword">var</span> pool = [];
    <span class="hljs-keyword">if</span> ( tournament_size &lt;= <span class="hljs-number">1</span> ) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span> (<span class="hljs-string">"Tournament size too small"</span>);
    }
    <span class="hljs-keyword">do</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>var joust = [];</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> best =  <span class="hljs-keyword">this</span>.population[ <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-keyword">this</span>.population.length) ] ;
	<span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; tournament_size; i ++) {
	    <span class="hljs-keyword">var</span> another= <span class="hljs-keyword">this</span>.population[ <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random()*<span class="hljs-keyword">this</span>.population.length) ];
	    <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.fitness_of[another] &gt; <span class="hljs-keyword">this</span>.fitness_of[best]) {
		best = another;
	    }
	}
	pool.push( best );
    } <span class="hljs-keyword">while</span> (pool.length &lt; pool_size );
    <span class="hljs-keyword">return</span> pool;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Applies operators to the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reproduction</span><span class="hljs-params">(  pool )</span> </span>{
    <span class="hljs-keyword">var</span> offspring = [];
    <span class="hljs-keyword">while</span> (pool.length ) {
	<span class="hljs-keyword">var</span> first = pool.splice( <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random()*pool.length), <span class="hljs-number">1</span> );
	<span class="hljs-keyword">var</span> second = pool.splice( <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random()*pool.length), <span class="hljs-number">1</span> );
	<span class="hljs-keyword">var</span> crossovers = crossover( first[<span class="hljs-number">0</span>], second[<span class="hljs-number">0</span>] );
	<span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> crossovers ) {
	    offspring.push( mutate(crossovers[i]));
	}
    }
    <span class="hljs-keyword">return</span> offspring;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Evaluates all the population not in cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">evaluation</span><span class="hljs-params">( new_guys )</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> new_guys) {
	<span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.fitness_of[new_guys[i]]) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <pre><code><span class="hljs-built_in">console</span>.log( <span class="hljs-string">"eval "</span> + new_guys[i] );
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>	    <span class="hljs-keyword">this</span>.fitness_of[new_guys[i]] = <span class="hljs-keyword">this</span>.fitness_obj.apply( new_guys[i]);
	}
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">order</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> fitness_of = <span class="hljs-keyword">this</span>.fitness_of;
    <span class="hljs-keyword">var</span> sorted_population = <span class="hljs-keyword">this</span>.population.sort( <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(a,b)</span></span>{ <span class="hljs-keyword">return</span> fitness_of[b] - fitness_of[a]; } );
    <span class="hljs-keyword">this</span>.population = sorted_population;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Single generation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">generation</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> chosen = <span class="hljs-keyword">this</span>.tournament_selection( <span class="hljs-keyword">this</span>.tournament_size, <span class="hljs-keyword">this</span>.pool_size);
    <span class="hljs-keyword">this</span>.order();
    <span class="hljs-keyword">var</span> the_best = [<span class="hljs-keyword">this</span>.population[<span class="hljs-number">0</span>],<span class="hljs-keyword">this</span>.population[<span class="hljs-number">1</span>]];
    <span class="hljs-keyword">var</span> new_population = <span class="hljs-keyword">this</span>.reproduction( chosen);
    <span class="hljs-keyword">this</span>.evaluation(new_population);
    <span class="hljs-keyword">this</span>.population = the_best.concat( new_population );
    <span class="hljs-keyword">this</span>.order();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Population should be sorted, so the worst is the last</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">incorporate</span><span class="hljs-params">( chromosome )</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>   console.log(chromosome);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> ( chromosome.length !== <span class="hljs-keyword">this</span>.chromosome_size ) {
	<span class="hljs-keyword">throw</span> <span class="hljs-string">"Bad chromosome length"</span> + chromosome.length + <span class="hljs-string">"!="</span> + <span class="hljs-keyword">this</span>.chromosome_size;
    }
    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.fitness_of[chromosome]) {
	<span class="hljs-keyword">this</span>.fitness_of[chromosome] = <span class="hljs-keyword">this</span>.fitness_obj.apply( chromosome );
	<span class="hljs-keyword">this</span>.population.push( chromosome );
	<span class="hljs-keyword">this</span>.order();
	<span class="hljs-keyword">this</span>.population.pop();
    }
    
}

nodeo.Nodeo = Nodeo;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
